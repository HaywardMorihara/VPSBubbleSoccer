<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>VPS Bubble Soccer</title>
        <script src="//cdn.jsdelivr.net/phaser/2.6.2/phaser.min.js"></script>
    </head>
    <body>

    <script src="controller.js"></script>
    <script src="player.js"></script> 
    <script src="ball.js"></script>
    <script type="text/javascript">

    window.onload = function() {

        var controller;

        var fieldLength = 720;
        var fieldWidth = 540;
        
        var wallWidth = 80;
        var midWallLength = 160;
        var goalWidth = 540 - 2 * midWallLength;

        var playerSpriteWidth = 111;

        var gameWidth = fieldLength + 2 * wallWidth;
        var gameHeight = fieldWidth + 2 * wallWidth;

        var music;

        var redScore = 0;
        var blueScore = 0;

        var game = new Phaser.Game(gameWidth, gameHeight, Phaser.CANVAS, 'vps-bubble-soccer', { preload: preload, create: create, update: update, render: render });

        var redScoreBoard;
        var blueScoreBoard;

        var topWall;
        var bottomWall;
        var midTopLeftWall;
        var midBottomLeftWall;
        var midTopRightWall;
        var midBottomRightWall;

        var redGoalRect;
        var blueGoalRect;

        var redGoal;
        var blueGoal;

        var ball;
        var player1;
        var player2;
        //var omfgDogs;

        function preload() {
            game.load.audio('omfgdogs_music', ['assets/music/omfgdogs.mp3']);//, 'assets/audio/bodenstaendig_2000_in_rock_4bit.ogg']); //ogg file for Firefox

            game.load.image('soccer_field', 'assets/sprites/soccerField.jpg');

            game.load.spritesheet('soccer_ball', 'assets/sprites/soccerball.png', 64, 64, 7);
            game.load.spritesheet('player','assets/sprites/annie.png',playerSpriteWidth, 115, 28);
            //game.load.spritesheet('omfgdogs','assets/sprites/omfgdogs-spritesheet.png',384,80,48)
        }


        function create() {
            initializeController();
            initializeMusic();
            initializeSprites();
            initializeAnimations();
            initializePhysics();   
        }

        function initializeController() {
            //Gamecube only works in Firefox...might be able to get external library if I want
            game.input.gamepad.start();
            // To listen to buttons from a specific pad listen directly on that pad game.input.gamepad.padX, where X = pad 1-4
            controller = game.input.gamepad.pad1;
        }

        function initializeMusic() {
            music = game.add.audio('omfgdogs_music');
            music.play();
        }

        function initializeSprites() {
            redScoreBoard = game.add.text(16, 16, redScore.toString(), { fill: '#ff0000' });
            blueScoreBoard = game.add.text(gameWidth-40,16,blueScore.toString(), { fill: '#0000ff'});

            game.add.sprite(wallWidth, wallWidth, 'soccer_field');

            topWall = game.add.sprite(0, 0, null);
            bottomWall = game.add.sprite(0, wallWidth+fieldWidth, null);
            midTopLeftWall = game.add.sprite(0, wallWidth, null);
            midBottomLeftWall = game.add.sprite(0, wallWidth+midWallLength+goalWidth, null);
            midTopRightWall = game.add.sprite(wallWidth+fieldLength, wallWidth, null);
            midBottomRightWall = game.add.sprite(wallWidth+fieldLength, wallWidth+midWallLength+goalWidth, null);

            redGoalRect = new Phaser.Rectangle(0, wallWidth+midWallLength, wallWidth, goalWidth);
            blueGoalRect = new Phaser.Rectangle(wallWidth+fieldLength, wallWidth+midWallLength, wallWidth, goalWidth);

            redGoal = game.add.sprite(0, wallWidth+midWallLength, null);
            blueGoal = game.add.sprite(wallWidth+fieldLength, wallWidth+midWallLength, null); 

            ball = game.add.sprite(gameWidth/2,gameHeight/2,'soccer_ball');
            ball.anchor.setTo(0.5, 0.5);
            ball.scale.setTo(.75,.75);

            player1 = initializePlayer(game,1,wallWidth,wallWidth);
            player2 = initializePlayer(game,2,wallWidth+fieldLength-playerSpriteWidth,wallWidth);

            //omfgDogs = game.add.sprite(0,0,'omfgdogs');

        }

        function initializeAnimations() {
            ball.rollingBallAnim = ball.animations.add('rolling_ball'); 

            initializePlayerAnim(player1);
            initializePlayerAnim(player2);

            //omfgDogsRunning = omfgDogs.animations.add('omfgdogs_running');
            //omfgDogsRunning.play(10,false);
        }

        function initializePhysics() {
            game.physics.startSystem(Phaser.Physics.ARCADE);
            game.physics.enable([ball,player1,player2,redGoal,blueGoal,topWall,bottomWall,midTopLeftWall,midBottomLeftWall,midTopRightWall,midBottomRightWall], Phaser.Physics.ARCADE);
            
            initializeWallPhysics();

            redGoal.body.setSize(wallWidth,goalWidth,0,0);
            blueGoal.body.setSize(wallWidth,goalWidth,0,0);

            ball.body.collideWorldBounds = true;
            //This sets the image bounce energy for the horizontal
            // and vertical vectors (as an x,y point). "1" is 100% energy return
            ball.body.bounce.setTo(.8,.8);

            initializePlayerPhysics(player1);
            initializePlayerPhysics(player2);
        }

        function initializeWallPhysics() {
            topWall.body.setSize(gameWidth, wallWidth, 0, 0);
            topWall.body.immovable = true;

            bottomWall.body.setSize(gameWidth, wallWidth, 0, 0);
            bottomWall.body.immovable = true;

            midTopLeftWall.body.setSize(wallWidth,midWallLength,0,0);
            midTopLeftWall.body.immovable = true;

            midBottomLeftWall.body.setSize(wallWidth,midWallLength,0,0);
            midBottomLeftWall.body.immovable = true;

            midTopRightWall.body.setSize(wallWidth,midWallLength,0,0);
            midTopRightWall.body.immovable = true;

            midBottomRightWall.body.setSize(wallWidth,midWallLength,0,0);
            midBottomRightWall.body.immovable = true;
        }

        function update() {
            updatePhysics();
            updatePlayer(player1, controller);
            updatePlayer(player2, controller);

            game.physics.arcade.overlap(redGoal, ball, goalScored);
            game.physics.arcade.overlap(blueGoal, ball, goalScored);

            var goalsToWin = 5;
            if(redScore >= goalsToWin) {
                victory("Red");
            }
            if(blueScore >= goalsToWin) {
                victory("Blue");
            }

            animate();
        }

        function goalScored(goal,ball) {
            if(goal == redGoal){
                blueScore += 1;
                blueScoreBoard.setText(blueScore.toString());
            }else{
                redScore += 1;
                redScoreBoard.setText(redScore.toString());
            }
            resetBallAndPlayers();
        }

        function resetBallAndPlayers() {
            ball.body.position.setTo(gameWidth/2 - ball.width/2,gameHeight/2 - ball.height/2);
            ball.body.velocity.setTo(0,0);

            player1.body.position.setTo(wallWidth,wallWidth);
            player1.body.velocity.setTo(0,0);

            player2.body.position.setTo(wallWidth+fieldLength-playerSpriteWidth,wallWidth);
            player2.body.velocity.setTo(0,0);
        }

        function updatePhysics() {
            game.physics.arcade.collide(player1,ball);

            game.physics.arcade.collide(player2,ball);

            game.physics.arcade.collide(player1,player2);

            game.physics.arcade.collide(player1,topWall);
            game.physics.arcade.collide(player1,bottomWall);
            game.physics.arcade.collide(player1,midTopLeftWall);
            game.physics.arcade.collide(player1,midBottomLeftWall);
            game.physics.arcade.collide(player1,midTopRightWall);
            game.physics.arcade.collide(player1,midBottomRightWall);

            game.physics.arcade.collide(player2,topWall);
            game.physics.arcade.collide(player2,bottomWall);
            game.physics.arcade.collide(player2,midTopLeftWall);
            game.physics.arcade.collide(player2,midBottomLeftWall);
            game.physics.arcade.collide(player2,midTopRightWall);
            game.physics.arcade.collide(player2,midBottomRightWall);

            game.physics.arcade.collide(ball,topWall);
            game.physics.arcade.collide(ball,bottomWall);
            game.physics.arcade.collide(ball,midTopLeftWall);
            game.physics.arcade.collide(ball,midBottomLeftWall);
            game.physics.arcade.collide(ball,midTopRightWall);
            game.physics.arcade.collide(ball,midBottomRightWall);
        }

        function checkOverlap(spriteA, spriteB) {
            var boundsA = spriteA.getBounds();
            var boundsB = spriteB.getBounds();

            return Phaser.Rectangle.intersects(boundsA, boundsB);
        }

        function victory(winner) {
            var style = { font: "bold 32px Arial", fill: "#fff", boundsAlignH: "center", boundsAlignV: "middle" };

            text = game.add.text(0, 0, winner+" Team Wins!", style);
            text.setTextBounds(0, 100, 800, 100);
            text.setShadow(3, 3, 'rgba(0,0,0,0.5)', 2);
        
            //reset Game? menu?
            redScore = 0;
            blueScore = 0;

            //ball.destroy();
        }

        function animate() {
            animatePlayer(player1,controller);
            animatePlayer(player2,controller);
            animateBall(ball);
        }

        function render() {
            game.debug.geom(redGoalRect,'#ff0000');//gives the goal its color
            game.debug.geom(blueGoalRect,'#0000ff');

            //game.debug.bodyInfo(player1, 32, 32);

            game.debug.text("0:"+controller.axis(0),100,200);
            game.debug.text("1:"+controller.axis(1),100,250);
            game.debug.text("2:"+controller.axis(2),100,300);
            game.debug.text("3:"+controller.axis(3),100,350);
            game.debug.text("4:"+controller.axis(4),100,400);
            game.debug.text("5:"+controller.axis(5),100,450);
            game.debug.text("6:"+controller.axis(6),100,500);
            game.debug.text("7:"+controller.axis(7),100,550);
        }

    };

    </script>

    </body>
</html>