<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>VPS Bubble Soccer</title>
        <script src="//cdn.jsdelivr.net/phaser/2.6.2/phaser.min.js"></script>
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {

        var cursors;

        var gameWidth = 720;
        var gameHeight = 540;

        var music;

        //width, height, renderer, parent, state
        var game = new Phaser.Game(gameWidth, gameHeight, Phaser.CANVAS, 'vps-bubble-soccer', { preload: preload, create: create, update: update, render: render });

        var ball;
        var player;

        var rollingBallAnim;
        var playerWalkingRightAnim;
        var playerWalkingUpAnim;
        var playerWalkingDownAnim;
        var playerWalkingLeftAnim;

        function preload() {
            game.load.audio('omfgdogs_music', ['assets/music/omfgdogs.mp3']);//, 'assets/audio/bodenstaendig_2000_in_rock_4bit.ogg']); //ogg file for Firefox

            game.load.image('soccer_field', 'assets/sprites/soccerField.jpg');

            game.load.spritesheet('soccer_ball', 'assets/sprites/soccerball.png', 64, 64, 7);
            game.load.spritesheet('player','assets/sprites/annie.png',111, 115, 28);
        }


        function create() {
            game.physics.startSystem(Phaser.Physics.ARCADE);

            cursors = game.input.keyboard.createCursorKeys();

            music = game.add.audio('omfgdogs_music');
            //music.play(); //driving me crazy

            game.add.sprite(0, 0, 'soccer_field');

            ball = game.add.sprite(gameWidth/2,gameHeight/2,'soccer_ball');
            ball.anchor.setTo(0.5, 0.5);
            ball.scale.setTo(.75,.75);

            player = game.add.sprite(0,0,'player');
            player.scale.setTo(.75,.75);
            
            rollingBallAnim = ball.animations.add('rolling_ball'); 

            playerWalkingRightAnim = player.animations.add('player_walking_right',[0,1,2,3,4,5,6]);
            playerWalkingUpAnim = player.animations.add('player_walking_up',[7,8,9,10,11,12,13]);
            playerWalkingDownAnim = player.animations.add('player_walking_down',[14,15,16,17,18,19,20]);
            playerWalkingLeftAnim = player.animations.add('player_walking_left',[21,22,23,24,25,26,27]);

            game.physics.enable([ball,player], Phaser.Physics.ARCADE);

            ball.body.velocity.setTo(200,200);
            ball.body.collideWorldBounds = true;
            //This sets the image bounce energy for the horizontal
            // and vertical vectors (as an x,y point). "1" is 100% energy return
            ball.body.bounce.setTo(.9,.9);

            player.body.collideWorldBounds = true;
            player.body.bounce.setTo(.5,.5);

            
        }

        function update() {
            game.physics.arcade.collide(player,ball);


            var fps = Math.min(1, Math.max(Math.abs(player.body.velocity.x), Math.abs(player.body.velocity.y)) / 200) * 20;

            if (cursors.up.isDown)
            {
                player.body.velocity.y += -10;
                if(playerWalkingUpAnim.isPlaying) {
                            playerWalkingUpAnim.speed = fps;
                        } else {
                            playerWalkingUpAnim.play(fps, true);
                        }
            }
            else if (cursors.down.isDown)
            {
                player.body.velocity.y +=  10;
                if(playerWalkingDownAnim.isPlaying) {
                            playerWalkingDownAnim.speed = fps;
                        } else {
                            playerWalkingDownAnim.play(fps, true);
                        }
            }
            else if (cursors.left.isDown)
            {
                player.body.velocity.x += -10;
                if(playerWalkingLeftAnim.isPlaying) {
                            playerWalkingLeftAnim.speed = fps;
                        } else {
                            playerWalkingLeftAnim.play(fps, true);
                        }
            }
            else if (cursors.right.isDown)
            {
                player.body.velocity.x += 10;
                if(playerWalkingRightAnim.isPlaying) {
                            playerWalkingRightAnim.speed = fps;
                        } else {
                            playerWalkingRightAnim.play(fps, true);
                        }
            }else{
                playerWalkingRightAnim.stop();
                playerWalkingUpAnim.stop();
                playerWalkingDownAnim.stop();
                playerWalkingLeftAnim.stop();
            }

            var thetaRadians = Math.atan2(ball.body.velocity.y,ball.body.velocity.x);
            var thetaDegrees = thetaRadians * 180/Math.PI;
            ball.angle = thetaDegrees - 180; //backwards so needed to turn around

            if (ball.body.velocity.x == 0 && ball.body.velocity.y == 0) {
                rollingBallAnim.stop();
            } else {
                var fps = Math.min(1, Math.max(Math.abs(ball.body.velocity.x),
                            Math.abs(ball.body.velocity.y)) / 200) * 20;//animation speed is specified in frames per second and has a minimum value of 1. I want the maximum frame speed to be 20, and I want to use that when the velocity of the ball is equal to or greater than 200. Velocities under 200 will calculate an animation frame rate as a ratio, but not go under 1. A velocity of 100 will result in a frame rate of 4.5, for example
                if (rollingBallAnim.isPlaying) {
                    rollingBallAnim.speed = fps;
                } else {
                    rollingBallAnim.play(fps, true);
                }
            }

        }

        function render() {

        }

    };

    </script>

    </body>
</html>